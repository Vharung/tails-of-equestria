const ActorSheetV2 = foundry.applications.sheets.ActorSheetV2;
const { HandlebarsApplicationMixin } = foundry.applications.api;
import PonyChat from "../document/chat.js";
import DifficultyDialogV2 from "../document/dialog.js";

/** Gestion de la feuille de personnage */

export default class PonyCharacterSheet extends HandlebarsApplicationMixin(ActorSheetV2) {
  /** @override */
  static DEFAULT_OPTIONS = {
    classes: ["tails-of-equestria", "actor", "character"],
    position: { width: 685, height: 890 },
    form: { submitOnChange: true },
    window: {
      resizable: true,
      title: "Fiche de personnage ", // <- titre de la fen√™tre
      id: "pony-character-sheet",   // <- identifiant unique
      frame: true,                  // <- force la cr√©ation d‚Äôune fen√™tre
      icon: "fa-solid fa-horse",    // <- facultatif
    },
    dragDrop: [{ dragSelector: '[data-drag]', dropSelector: '.list' }], // Remplacer '.inventory-list' par votre s√©lecteur    tabGroups: { sheet: "inventory" },
    actions: {
      editImage: PonyCharacterSheet.#onEditImage,
      edit: PonyCharacterSheet.#onItemAction,
      use: PonyCharacterSheet.#onItemAction,
      delete: PonyCharacterSheet.#onItemAction,
      roll:PonyCharacterSheet.#onActorAction,
      addItem:PonyCharacterSheet.#onItemAction,
      addMagic:PonyCharacterSheet.#onItemAction,
      addDefaut:PonyCharacterSheet.#onItemAction,
      creer:PonyCharacterSheet.#onCreer
    }
  };

  /** @override */
  static PARTS = {
    header: { template: "systems/tails-of-equestria/templates/actors/character-header.hbs" },
    nav: { template: "systems/tails-of-equestria/templates/actors/character-nav.hbs" },
    biography: { template: "systems/tails-of-equestria/templates/actors/character-biography.hbs" },
    main: { template: "systems/tails-of-equestria/templates/actors/character-main.hbs" }
  };



  /** Pr√©paration des donn√©es */
  async _prepareContext() {
    const system = this.document.system;
    const actor = this.document;
    // --- Retour du contexte pour le template
    return {
      tabs: this.#getTabs(),
      fields: this.document.schema.fields,
      systemFields: system.schema.fields,
      actor,
      system,
      source: this.document.toObject(),
      items: this.document.items.toObject(),
    };
  }






  async _preparePartContext(partId, context) {
    return context;
  }

  async _onRender(context, options) {
    super._onRender(context, options);
    //console.log('render')
    console.log(context)

    const system = this.actor.system;
    const el = this.element[0]; // wrapper principal

    /* === üîπ DRAG & DROP === */
    el.querySelectorAll('[data-drag]').forEach(item => {
      item.addEventListener('dragstart', () => {}); // placeholder
    });

    // === üîπ ONGLET ACTIF === 
    //conserver le dernier onglet ouvert
    if (!this.actor) return;
    // R√©cup√©rer l'onglet actif sp√©cifique √† ce personnage (ou valeur par d√©faut)
    const activeTab = localStorage.getItem(`activeTab-${this.actor.id}`) || "carac"; 
    // Appliquer l'affichage correct
    this._setActiveTab(activeTab);
    // G√©rer le clic sur les onglets pour changer de vue
    this.element.querySelectorAll(".sheet-tabs [data-tab]").forEach(tab => {
      tab.addEventListener("click", (event) => {
        const newTab = event.currentTarget.dataset.tab;
        this._setActiveTab(newTab);
      });
      
    });
  }

  static async #onEditImage(event, target) {
    const attr = target.dataset.edit;
    const current = foundry.utils.getProperty(this.document, attr);
    const { img } =
        this.document.constructor.getDefaultArtwork?.(this.document.toObject()) ??
        {};
    const fp = new FilePicker({
        current,
        type: 'image',
        redirectToRoot: img ? [img] : [],
        callback: (path) => {
            this.document.update({ [attr]: path });
        },
        top: this.position.top + 40,
        left: this.position.left + 10,
    });
    return fp.browse();
    }


    static async #onCreer(event) {
      event?.preventDefault();

      const actor = this.actor;
      const system = actor.system;
      // --- üîπ Tableau des races et leurs caract√©ristiques
      const raceData = {
        "alicorn": {
          body: "d8", mind: "d12", charm: "d10", robustness: 20,
          talents: ["Vol", "T√©l√©kin√©sie", "C≈ìur vaillant", "Sorts avanc√©s"],
          quirks: ["Arrogant", "Responsabilit√© royale"]
        },
        "bison": {
          body: "d12", mind: "d6", charm: "d6", robustness: 18,
          talents: ["Charge", "Peau √©paisse", "Talent √† choisir"],
          quirks: ["Fier", "Faiblesse √† choisir"]
        },
        "changelin": {
          body: "d4", mind: "d4", charm: "d4", robustness: 8,
          talents: ["M√©tamorphose", "T√©l√©kin√©sie", "C≈ìur vaillant", "Vol"],
          quirks: ["Affam√© d'Amour", "Faiblesse √† choisir"]
        },
        "caribou": {
          body: "d8", mind: "d8", charm: "d8", robustness: 12,
          talents: ["C≈ìur Vaillant", "R√©sistance magique", "Berserker", "Talent √† choisir"],
          quirks: ["Col√©rique", "Faiblesse √† choisir"]
        },
        "cerf": {
          body: "d6", mind: "d6", charm: "d8", robustness: 12,
          talents: ["Sabot Vert", "Furtivit√©", "Territorial", "Talent √† choisir"],
          quirks: ["Protecteur", "Faiblesse √† choisir"]
        },
        "chat": {
          body: "d6", mind: "d6", charm: "d6", robustness: 12,
          talents: ["Griffes", "Furtivit√©", "Talent √† choisir"],
          quirks: ["√âgo√Øste", "Faiblesse √† choisir"]
        },
        "cheval": {
          body: "d8", mind: "d8", charm: "d6", robustness: 12,
          talents: ["Intellect Sage", "Savant", "C≈ìur vaillant", "Talent √† choisir"],
          quirks: ["Ind√©pendant", "Faiblesse √† choisir"]
        },
        "chien": {
          body: "d6", mind: "d6", charm: "d6", robustness: 12,
          talents: ["Fouissage", "Pistage", "Talent √† choisir"],
          quirks: ["Avide", "Faiblesse √† choisir"]
        },
        "cristal": {
          body: "d6", mind: "d6", charm: "d6", robustness: 12,
          talents: ["C≈ìur vaillant", "T√©l√©kin√©sie", "Talent √† choisir"],
          quirks: ["C≈ìur de Cristal", "Faiblesse √† choisir"]
        },
        "dragon": {
          body: "d8", mind: "d4", charm: "d4", robustness: 12,
          talents: ["Vol", "Souffle √âl√©mentaire", "Talent √† choisir"],
          quirks: ["Avidit√© du Dragon", "Oooohhh... Brillant !"]
        },
        "griffon": {
          body: "d6", mind: "d6", charm: "d6", robustness: 12,
          talents: ["Vol", "Griffes", "Talent √† choisir"],
          quirks: ["√âgo√Øste", "Faiblesse √† choisir"]
        },
        "hypogriffe": {
          body: "d6", mind: "d6", charm: "d6", robustness: 12,
          talents: ["Vol", "Honorable", "Natation", "Talent √† choisir"],
          quirks: ["Protecteur", "Faiblesse √† choisir"]
        },
        "kirin": {
          body: "d6", mind: "d6", charm: "d8", robustness: 12,
          talents: ["T√©l√©kin√©sie", "C≈ìur de Kirin", "Talent √† choisir"],
          quirks: ["Nirik", "Faiblesse √† choisir"]
        },
        "longma": {
          body: "d6", mind: "d6", charm: "d8", robustness: 12,
          talents: ["Vol", "Souffle √âl√©mentaire", "Asc√©tisme Draconique", "Talent de Marque de Beaut√©"],
          quirks: ["Col√©rique", "Faiblesse √† choisir"]
        },
        "minotaure": {
          body: "d10", mind: "d6", charm: "d6", robustness: 12,
          talents: ["Robuste", "Intimidation", "Col√©rique", "Talent √† choisir"],
          quirks: ["Court Fusible", "Faiblesse √† choisir"]
        },
        "p√©gase": {
          body: "d6", mind: "d6", charm: "d6", robustness: 12,
          talents: ["Vol", "Manipulation des Nuages", "Talent de Marque de Beaut√©"],
          quirks: ["Comp√©titif", "Faiblesse √† choisir"]
        },
        "poney": {
          body: "d8", mind: "d6", charm: "d6", robustness: 14,
          talents: ["C≈ìur vaillant", "Poney Polyvalent", "Talent de Marque de Beaut√©"],
          quirks: ["Rustique", "Faiblesse √† choisir"]
        },
        "licorne": {
          body: "d4", mind: "d8", charm: "d6", robustness: 12,
          talents: ["T√©l√©kin√©sie", "Sorts avanc√©s", "Talent de Marque de Beaut√©"],
          quirks: ["Arrogant", "Faiblesse √† choisir"]
        },
        "reptilien": {
          body: "d8", mind: "d4", charm: "d6", robustness: 12,
          talents: ["Natation", "Peau √âpaisse", "Talent √† choisir"],
          quirks: ["Froid", "Faiblesse √† choisir"]
        },
        "yack": {
          body: "d10", mind: "d6", charm: "d4", robustness: 16,
          talents: ["Artisanat", "Peau √âpaisse", "Massif", "Talent √† choisir"],
          quirks: ["Pointilleux", "Faiblesse √† choisir"]
        },
        "z√®bre": {
          body: "d6", mind: "d8", charm: "d6", robustness: 12,
          talents: ["Toucher Gu√©risseur", "Pacte Spirituel", "Talent de Marque de Beaut√©"],
          quirks: ["Langage en Rimes", "Faiblesse √† choisir"]
        }
      };

      // --- üîπ R√©cup√©ration et validation de la race
      const raceKey = (system.race ?? "").trim().toLowerCase();
      if (!raceKey || !raceData[raceKey]) {
        ui.notifications.warn("‚ö†Ô∏è Race invalide ou non d√©finie !");
        return;
      }
      console.log(raceKey);

      const data = raceData[raceKey];
      console.log(`üê¥ G√©n√©ration de ${actor.name} (${raceKey})`, data);

      // --- üîπ Mise √† jour automatique des caract√©ristiques
      await actor.update({
        "system.body": data.body,
        "system.mind": data.mind,
        "system.charm": data.charm,
        "system.robustness.max": data.robustness,
        "system.robustness.current": Math.min(system.robustness.current, data.robustness)
      });

      // --- üîπ V√©rifie les talents existants
      const existingTalents = actor.items.filter(i => i.type === "talent").map(i => i.name);
      const missingTalents = data.talents.filter(t => !existingTalents.includes(t));

      // --- üîπ V√©rifie les faiblesses existantes
      const existingQuirks = actor.items.filter(i => i.type === "faiblesse").map(i => i.name);
      const missingQuirks = data.quirks.filter(q => !existingQuirks.includes(q));

      if (missingTalents.length === 0 && missingQuirks.length === 0) {
        ui.notifications.info("‚úÖ Tous les talents et faiblesses sont d√©j√† pr√©sents.");
        return;
      }

      console.log(`üîç Talents manquants :`, missingTalents);
      console.log(`üîç Faiblesses manquantes :`, missingQuirks);

     // --- üîπ Recherche dans le compendium 'libersf.inventaire'
      const pack = game.packs.get('tails-of-equestria.inventaire');
      if (!pack) {
        ui.notifications.error("Compendium 'tails-of-equestria.inventaire' introuvable !");
        return;
      }

      // R√©cup√®re l'index (l√©ger) une fois pour toutes les recherches
      const index = await pack.getIndex();
      const itemsToAdd = [];

      // Fonction utilitaire pour trouver un item dans l'index (insensible √† la casse, exact ou fuzzy)
      const findEntryByName = (name) => {
        const lc = (name || "").toLowerCase().trim();
        // 1) correspondance exacte
        let entry = index.find(e => (e.name || "").toLowerCase() === lc);
        if (entry) return entry;
        // 2) correspondance qui contient le nom (fuzzy)
        entry = index.find(e => lc.includes((e.name || "").toLowerCase()) || (e.name || "").toLowerCase().includes(lc));
        return entry || null;
      };

      // --- üß© Ajout des talents manquants
      for (const talentName of missingTalents) {
        let itemFound = null;
        const entry = findEntryByName(talentName);
        if (entry) {
          const id = entry._id ?? entry.id;
          try {
            itemFound = await pack.getDocument(id);
          } catch (err) {
            console.warn(`Erreur en r√©cup√©rant le document ${talentName} (${id}) du pack :`, err);
            itemFound = null;
          }
        }

        if (itemFound) {
          console.log(`‚úÖ Talent trouv√© : ${talentName}`);
          itemsToAdd.push(itemFound.toObject());
        } else {
          console.warn(`‚ö†Ô∏è Talent introuvable : ${talentName}, cr√©ation d‚Äôun placeholder.`);
          itemsToAdd.push({
            name: talentName,
            type: "talent",
            system: {
              niveau: "D6",
              description: "Talent ajout√© automatiquement (placeholder)."
            }
          });
        }
      }

      // --- üß© Ajout des faiblesses manquantes
      for (const quirkName of missingQuirks) {
        let itemFound = null;
        const entry = findEntryByName(quirkName);
        if (entry) {
          const id = entry._id ?? entry.id;
          try {
            itemFound = await pack.getDocument(id);
          } catch (err) {
            console.warn(`Erreur en r√©cup√©rant le document ${quirkName} (${id}) du pack :`, err);
            itemFound = null;
          }
        }

        if (itemFound) {
          console.log(`‚úÖ Faiblesse trouv√©e : ${quirkName}`);
          itemsToAdd.push(itemFound.toObject());
        } else {
          console.warn(`‚ö†Ô∏è Faiblesse introuvable : ${quirkName}, cr√©ation d‚Äôun placeholder.`);
          itemsToAdd.push({
            name: quirkName,
            type: "faiblesse",
            system: {
              description: "Faiblesse ajout√©e automatiquement (placeholder)."
            }
          });
        }
      }

      // --- üîπ Cr√©ation des documents manquants
      if (itemsToAdd.length > 0) {
        await actor.createEmbeddedDocuments("Item", itemsToAdd);
        ui.notifications.info(`${itemsToAdd.length} √©l√©ment(s) (talent/faiblesse) ajout√©(s) √† ${actor.name}.`);
      }


    }




/* ==========================================================
*  G√©n√©rateur de la fiche de personnage
* ========================================================== */

  /**
   * G√®re toutes les actions de g√©n√©ration ou de mise √† jour automatique du personnage.
   * @param {PointerEvent} event - L'√©v√©nement d'origine
   * @param {HTMLElement} target - √âl√©ment HTML qui contient [data-action]
   */
  static async #onActorAction(event, target) {
    event.preventDefault();

    const actor = this.actor;
    const action = target.dataset.action;

    if (!actor || !action) return;

    function getRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    switch (action) {

      // üé≤ --- LANCER DE JET ---
      case "roll": {
        const stat =target.dataset.stat;
        const dice =target.dataset.dice;
        await this._generateRoll(actor, stat, dice);
        break;
      }

      default:
        console.warn(`Action inconnue : ${action}`);
    }
  }

/* ==========================================================
*  Onglet de la fiche de personnage
* ========================================================== */
  
  /*conserver le dernier onglet ouvert*/
  /** @override */
  _setActiveTab(tabId) {
      if (!this.actor) return;

      // Stocker l'onglet actif en utilisant l'ID de l'acteur
      localStorage.setItem(`activeTab-${this.actor.id}`, tabId);

      // Masquer tous les onglets
      this.element.querySelectorAll(".tab").forEach(tab => {
          tab.style.display = "none";
      });

      // Afficher seulement l'onglet actif
      const activeTab = this.element.querySelector(`.tab[data-tab="${tabId}"]`);
      if (activeTab) {
          activeTab.style.display = "block";
      }

      // Mettre √† jour la classe "active" dans la navigation
      this.element.querySelectorAll(".sheet-tabs [data-tab]").forEach(tab => {
          tab.classList.remove("active");
      });

      const activeTabNav = this.element.querySelector(`.sheet-tabs [data-tab="${tabId}"]`);
      if (activeTabNav) {
          activeTabNav.classList.add("active");
      }

      const GM = game.user.isGM;
      if (!GM) { // V√©rifie si le joueur n'est PAS GM
        document.querySelectorAll('.reponse').forEach(element => {
          element.style.display = "none"; // Corrig√© "this" -> "element"
        });
      }
  }


  
  /** Gestion des onglets */
  #getTabs() {
    const tabs = {
      carac: { id: "carac", group: "sheet", icon: "fa-solid fa-shapes", label: "Pony.Labels.carac" },
      items: { id: "items", group: "sheet", icon: "fa-solid fa-shapes", label: "Pony.Labels.items" },
    };

    for (const v of Object.values(tabs)) {
      v.active = this.tabGroups[v.group] === v.id;
      v.cssClass = v.active ? "active" : "";
    }
    return tabs;
  }


/* ==========================================================
*  Item de la fiche de personnage
* ========================================================== */
  static async #onItemAction(event, target) {
    event.preventDefault();

    const action = target.dataset.action;
    const itemId = target.dataset.itemId;
    const actor = this.actor;
    const item = actor.items.get(itemId);

    //if (!item) return ui.notifications.warn("Item introuvable.");

    switch (action) {

      /* --- üõ†Ô∏è √âDITION --- */
      case "edit":
        return item.sheet.render(true);

      /* --- üóëÔ∏è SUPPRESSION --- */
      case "delete":
        return item.delete();

      /* --- ‚öîÔ∏è UTILISATION SIMPLE (consommable) --- */
      case "use": {
        const qty = item.system.quantity || 0;
        if (qty > 1) await item.update({ "system.quantity": qty - 1 });
        else await item.delete();
        return;
      }

      /* --- ‚ûï AJOUT D‚ÄôUN OBJET --- */
      case "addItem": {
        const newItem = await Item.create({
          name: game.i18n.localize("Pony.Character.Sheet.Objet"),
          type: "item",
          system: {
            quantity: 1,
            description: ""
          }
        }, { parent: actor });
        return ui.notifications.info(`Objet "${newItem.name}" ajout√© √† ${actor.name}.`);
      }

      /* --- ‚ú® AJOUT D‚ÄôUNE MAGIE --- */
      case "addMagic": {
        const newItem = await Item.create({
          name: game.i18n.localize("Pony.Character.Sheet.Talent"),
          type: "talent",
          system: {
            dice: "d4",
            description: ""
          }
        }, { parent: actor });
        return ui.notifications.info(`Talent "${newItem.name}" ajout√©e √† ${actor.name}.`);
      }
      /* --- ‚ú® AJOUT D‚ÄôUNE MAGIE --- */
      case "addDefaut": {
        const newItem = await Item.create({
          name: game.i18n.localize("Pony.Character.Sheet.Faiblesse"),
          type: "faiblesse",
          system: {
            dice: "d4",
            description: ""
          }
        }, { parent: actor });
        return ui.notifications.info(`Defaut "${newItem.name}" ajout√©e √† ${actor.name}.`);
      }

      default:
        console.warn(`Action inconnue : ${action}`);
    }
  }


/* ==========================================================
*  Action de la fiche de personnage
* ========================================================== */ 
  /**
 * G√®re un jet de caract√©ristique (ex : Corps, Esprit, Charme)
 * @param {Actor} actor - L'acteur qui fait le jet
 * @param {string} stat - Le nom de la caract√©ristique (ex: "body")
 */
  async _generateRoll(actor, stat, dice) {
    const system = actor.system;
    let label;
    let statValue;
    let dieSides;

    // üé≤ 1. Gestion d‚Äôun d√© transmis directement (ex: "d8" ou "d20+d10")
    if (dice) {
      label = stat;
      if (dice === "d30") dice = "d20+1d10";
      dieSides = "1" + dice;
    } else {
      label = stat.charAt(0).toUpperCase() + stat.slice(1);

      // ‚úÖ Tableau de correspondance des d√©s
      const diceMap = {
        D4: "1d4",
        D6: "1d6",
        D8: "1d8",
        D10: "1d10",
        D12: "1d12",
        D20: "1d20"
      };

      // R√©cup√©ration du d√© de l'attribut
      statValue = system[stat]?.toUpperCase() ?? "D6";
      dieSides = diceMap[statValue] || "1d6";
    }

    // üéØ 2. Demander la difficult√© et le talent √† l'utilisateur
    const result = await new Promise(resolve => {
      new DifficultyDialogV2(actor, resolve).render(true);
    });

    if (!result) return; // Annul√©
    const { diff: level, talent } = result;

    // üéì 3. Identifier le d√© du talent choisi
    let talentName = "Aucun talent";
    let talentDice = null;

    if (talent && talent !== "none") {
      const talentItem = actor.items.get(talent);
      if (talentItem) {
        talentName = talentItem.name;
        // Exemple : ton talent a une propri√©t√© "system.dice" = "D8"
        const talentDie = talentItem.system?.dice?.toUpperCase?.() ?? "D6";
        const diceMap = { D4: "1d4", D6: "1d6", D8: "1d8", D10: "1d10", D12: "1d12", D20: "1d20" };
        talentDice = diceMap[talentDie] || "1d6";
      }
    }

    // üéÜ 4. Fonction de jet explosif (avec cumul des explosions)
    const rollExplode = async (formula) => {
      const match = formula.match(/(\d+)d(\d+)/i);
      const sides = match ? parseInt(match[2]) : 6;
      let total = 0;
      let rolls = [];
      let keepRolling = true;

      while (keepRolling) {
        const r = new Roll(formula);
        await r.evaluate();
        const result = r.total;
        total += result;
        rolls.push(result);

        keepRolling = (result === sides);
      }

      const detail = rolls
        .map(r => (r === sides ? `<span class="explosif">${r}</span>` : `${r}`))
        .join(" + ");

      return { total, detail };
    };

    // üé≤ 5. Lancer les d√©s (attribut et talent)
    const rollAttr = await rollExplode(dieSides);
    let bestResult = rollAttr;
    let rollTalent = null;

    if (talentDice) {
      rollTalent = await rollExplode(talentDice);
      if (rollTalent.total > rollAttr.total) bestResult = rollTalent;
    }

    // üß© 6. D√©terminer la r√©ussite
    const success = bestResult.total >= level;
    const resultText = success
      ? `<span style="background:#bbe9f0;color:#f237a6;width: 100%;display: block;text-align: center;padding: 10px;">Succ√®s !</span>`
      : `<span style="background:#f237a6;color:#bbe9f0;width: 100%;display: block;text-align: center;padding: 10px;">√âchec.</span>`;

    // üí¨ 7. Construire le message du chat
    const jetLabel = game.i18n.localize("Pony.Character.Sheet.Jet") ?? "Jet";
    const parts = [
      `üé≤ <b>${jetLabel} ${label}</b> (${statValue ?? dieSides}) de <b>${actor.name}</b>`,
      `<span class="resultdice">Difficult√© : <b>${level}</b></span>`,
      `<span class="resultdice"><b>Attribut :</b> ${rollAttr.detail} = <b>${rollAttr.total}</b>`,
    ];

    if (rollTalent) {
      parts.push(`<b>Talent (${talentName}) :</b> ${rollTalent.detail} = <b>${rollTalent.total}</b>`);
      parts.push(`<b>R√©sultat retenu :</b> ${bestResult.total}`);
    }
    parts.push('</span>');
    const message = `${parts.join("<br/>")}<br/>${resultText}`;

    // üí¨ 8. Envoi du message dans le chat
    ChatMessage.create({
      speaker: ChatMessage.getSpeaker({ actor }),
      content: message,
    });

    console.log(`${actor.name} lance ${dieSides}${talentDice ? " + " + talentDice : ""} ‚Üí ${bestResult.total} (DC ${level}) ‚Üí ${success ? "Succ√®s" : "√âchec"}`);
  }


}
